name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no actual release)'
        required: false
        type: boolean
        default: false

# Sequentielle Ausf체hrung f체r Release-Workflow
concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    # Skip wenn Commit von Release-Bot kommt
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .[dev]

      - name: Run tests
        run: pytest tests/ -v

  release:
    name: Create Release
    needs: test
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.changelog.outputs.version }}
      tag: ${{ steps.changelog.outputs.tag }}
      skipped: ${{ steps.changelog.outputs.skipped }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Vollst채ndige History f체r Tags

      - name: Conventional Changelog Action
        id: changelog
        uses: TriPSs/conventional-changelog-action@v5
        with:
          github-token: ${{ github.token }}
          output-file: "CHANGELOG.md"
          skip-version-file: false
          version-file: "pyproject.toml"
          version-path: "project.version"
          git-message: "chore(release): {version} [skip ci]"
          tag-prefix: "v"
          preset: "conventionalcommits"
          skip-commit: ${{ inputs.dry_run || false }}
          skip-tag: ${{ inputs.dry_run || false }}

      - name: Show release info
        if: steps.changelog.outputs.skipped == 'false'
        run: |
          echo "=== Release Info ==="
          echo "Version: ${{ steps.changelog.outputs.version }}"
          echo "Tag: ${{ steps.changelog.outputs.tag }}"
          echo ""
          echo "=== Changelog ==="
          echo "${{ steps.changelog.outputs.clean_changelog }}"

      - name: No release needed
        if: steps.changelog.outputs.skipped == 'true'
        run: |
          echo "No version-relevant commits found."
          echo "Commits with feat:, fix:, or BREAKING CHANGE trigger releases."

  build:
    name: Build Package
    needs: release
    if: needs.release.outputs.skipped == 'false'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.tag }}

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install build tools
        run: pip install build

      - name: Build package
        run: python -m build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  github-release:
    name: Create GitHub Release
    needs: [release, build]
    if: needs.release.outputs.skipped == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ github.token }}
          tag: ${{ needs.release.outputs.tag }}
          name: Release ${{ needs.release.outputs.tag }}
          body: |
            ## What's Changed

            ${{ needs.release.outputs.changelog }}

            ## Installation

            ```bash
            pip install badge-gen==${{ needs.release.outputs.version }}
            ```
          artifacts: "dist/*"
          draft: false
          prerelease: false
